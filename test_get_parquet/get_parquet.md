Read large file in chunks and convert to Parquet
================

``` r
pacman::p_load(
        rio,            # import and export files
        here,           # locate files 
        tidyverse,      # data management and visualization
        arrow,
        data.table
)
```

## Testing

### Data

``` r
# data #-----------
data_path <- here("big_data_analytics/data/inflation.csv")

(data <- fread(data_path))
```

    ##           date inflation_percent
    ##         <IDat>             <num>
    ##  1: 1960-01-01         1.4579760
    ##  2: 1961-01-01         1.0707241
    ##  3: 1962-01-01         1.1987733
    ##  4: 1963-01-01         1.2396694
    ##  5: 1964-01-01         1.2789116
    ##  6: 1965-01-01         1.5851693
    ##  7: 1966-01-01         3.0150754
    ##  8: 1967-01-01         2.7727856
    ##  9: 1968-01-01         4.2717962
    ## 10: 1969-01-01         5.4623862
    ## 11: 1970-01-01         5.8382553
    ## 12: 1971-01-01         4.2927667
    ## 13: 1972-01-01         3.2722782
    ## 14: 1973-01-01         6.1777601
    ## 15: 1974-01-01        11.0548048
    ## 16: 1975-01-01         9.1431469
    ## 17: 1976-01-01         5.7448126
    ## 18: 1977-01-01         6.5016840
    ## 19: 1978-01-01         7.6309638
    ## 20: 1979-01-01        11.2544711
    ## 21: 1980-01-01        13.5492020
    ## 22: 1981-01-01        10.3347153
    ## 23: 1982-01-01         6.1314270
    ## 24: 1983-01-01         3.2124352
    ## 25: 1984-01-01         4.3005355
    ## 26: 1985-01-01         3.5456442
    ## 27: 1986-01-01         1.8980477
    ## 28: 1987-01-01         3.6645632
    ## 29: 1988-01-01         4.0777411
    ## 30: 1989-01-01         4.8270030
    ## 31: 1990-01-01         5.3979564
    ## 32: 1991-01-01         4.2349640
    ## 33: 1992-01-01         3.0288197
    ## 34: 1993-01-01         2.9516570
    ## 35: 1994-01-01         2.6074416
    ## 36: 1995-01-01         2.8054197
    ## 37: 1996-01-01         2.9312042
    ## 38: 1997-01-01         2.3376899
    ## 39: 1998-01-01         1.5522791
    ## 40: 1999-01-01         2.1880272
    ## 41: 2000-01-01         3.3768573
    ## 42: 2001-01-01         2.8261711
    ## 43: 2002-01-01         1.5860316
    ## 44: 2003-01-01         2.2700950
    ## 45: 2004-01-01         2.6772367
    ## 46: 2005-01-01         3.3927468
    ## 47: 2006-01-01         3.2259441
    ## 48: 2007-01-01         2.8526725
    ## 49: 2008-01-01         3.8391003
    ## 50: 2009-01-01        -0.3555463
    ## 51: 2010-01-01         1.6400434
    ## 52: 2011-01-01         3.1568416
    ## 53: 2012-01-01         2.0693373
    ## 54: 2013-01-01         1.4648327
    ## 55: 2014-01-01         1.6222230
    ## 56: 2015-01-01         0.1186271
    ## 57: 2016-01-01         1.2615832
    ## 58: 2017-01-01         2.1301100
    ## 59: 2018-01-01         2.4425833
    ## 60: 2019-01-01         1.8122101
    ## 61: 2020-01-01         1.2335844
    ##           date inflation_percent

``` r
dim(data)
```

    ## [1] 61  2

### Read large files in chunks ➔ convert to Parquet

``` r
# chunks #------------
(column_names <- names(data))
```

    ## [1] "date"              "inflation_percent"

``` r
(parquet_folder <- here("test_get_parquet/data_parquet/"))
```

    ## [1] "G:/My Drive/git/note_big_data/test_get_parquet/data_parquet"

Chunk1

``` r
nrows_to_read = 30
(chunk1 <- fread(data_path,
                nrows = nrows_to_read))
```

    ##           date inflation_percent
    ##         <IDat>             <num>
    ##  1: 1960-01-01          1.457976
    ##  2: 1961-01-01          1.070724
    ##  3: 1962-01-01          1.198773
    ##  4: 1963-01-01          1.239669
    ##  5: 1964-01-01          1.278912
    ##  6: 1965-01-01          1.585169
    ##  7: 1966-01-01          3.015075
    ##  8: 1967-01-01          2.772786
    ##  9: 1968-01-01          4.271796
    ## 10: 1969-01-01          5.462386
    ## 11: 1970-01-01          5.838255
    ## 12: 1971-01-01          4.292767
    ## 13: 1972-01-01          3.272278
    ## 14: 1973-01-01          6.177760
    ## 15: 1974-01-01         11.054805
    ## 16: 1975-01-01          9.143147
    ## 17: 1976-01-01          5.744813
    ## 18: 1977-01-01          6.501684
    ## 19: 1978-01-01          7.630964
    ## 20: 1979-01-01         11.254471
    ## 21: 1980-01-01         13.549202
    ## 22: 1981-01-01         10.334715
    ## 23: 1982-01-01          6.131427
    ## 24: 1983-01-01          3.212435
    ## 25: 1984-01-01          4.300535
    ## 26: 1985-01-01          3.545644
    ## 27: 1986-01-01          1.898048
    ## 28: 1987-01-01          3.664563
    ## 29: 1988-01-01          4.077741
    ## 30: 1989-01-01          4.827003
    ##           date inflation_percent

``` r
arrow::write_dataset(
        dataset = chunk1,
        format = "parquet",
        path = parquet_folder,
        max_rows_per_file = 10,
        basename_template = paste0("part1-{i}.parquet"))
```

Chunk2

``` r
(chunk2 <- fread(data_path,
                skip = nrows_to_read+1) %>%
        rename_with(~column_names))
```

    ##           date inflation_percent
    ##         <IDat>             <num>
    ##  1: 1990-01-01         5.3979564
    ##  2: 1991-01-01         4.2349640
    ##  3: 1992-01-01         3.0288197
    ##  4: 1993-01-01         2.9516570
    ##  5: 1994-01-01         2.6074416
    ##  6: 1995-01-01         2.8054197
    ##  7: 1996-01-01         2.9312042
    ##  8: 1997-01-01         2.3376899
    ##  9: 1998-01-01         1.5522791
    ## 10: 1999-01-01         2.1880272
    ## 11: 2000-01-01         3.3768573
    ## 12: 2001-01-01         2.8261711
    ## 13: 2002-01-01         1.5860316
    ## 14: 2003-01-01         2.2700950
    ## 15: 2004-01-01         2.6772367
    ## 16: 2005-01-01         3.3927468
    ## 17: 2006-01-01         3.2259441
    ## 18: 2007-01-01         2.8526725
    ## 19: 2008-01-01         3.8391003
    ## 20: 2009-01-01        -0.3555463
    ## 21: 2010-01-01         1.6400434
    ## 22: 2011-01-01         3.1568416
    ## 23: 2012-01-01         2.0693373
    ## 24: 2013-01-01         1.4648327
    ## 25: 2014-01-01         1.6222230
    ## 26: 2015-01-01         0.1186271
    ## 27: 2016-01-01         1.2615832
    ## 28: 2017-01-01         2.1301100
    ## 29: 2018-01-01         2.4425833
    ## 30: 2019-01-01         1.8122101
    ## 31: 2020-01-01         1.2335844
    ##           date inflation_percent

``` r
arrow::write_dataset(
        dataset = chunk2,
        format = "parquet",
        path = parquet_folder,
        max_rows_per_file = 10,
        basename_template = paste0("part2-{i}.parquet"))
```

### Compare original file and parquet files

``` r
df_parquet <- open_dataset(here("test_get_parquet/data_parquet/"))

dim(df_parquet)
```

    ## [1] 61  2

``` r
data1 <- df_parquet %>% collect()

bind_cols(data, data1) %>%
        select(contains("date"),
               contains("inflation"))
```

    ## New names:
    ## • `date` -> `date...1`
    ## • `inflation_percent` -> `inflation_percent...2`
    ## • `date` -> `date...3`
    ## • `inflation_percent` -> `inflation_percent...4`

    ##       date...1   date...3 inflation_percent...2 inflation_percent...4
    ##         <IDat>     <Date>                 <num>                 <num>
    ##  1: 1960-01-01 1960-01-01             1.4579760             1.4579760
    ##  2: 1961-01-01 1961-01-01             1.0707241             1.0707241
    ##  3: 1962-01-01 1962-01-01             1.1987733             1.1987733
    ##  4: 1963-01-01 1963-01-01             1.2396694             1.2396694
    ##  5: 1964-01-01 1964-01-01             1.2789116             1.2789116
    ##  6: 1965-01-01 1965-01-01             1.5851693             1.5851693
    ##  7: 1966-01-01 1966-01-01             3.0150754             3.0150754
    ##  8: 1967-01-01 1967-01-01             2.7727856             2.7727856
    ##  9: 1968-01-01 1968-01-01             4.2717962             4.2717962
    ## 10: 1969-01-01 1969-01-01             5.4623862             5.4623862
    ## 11: 1970-01-01 1970-01-01             5.8382553             5.8382553
    ## 12: 1971-01-01 1971-01-01             4.2927667             4.2927667
    ## 13: 1972-01-01 1972-01-01             3.2722782             3.2722782
    ## 14: 1973-01-01 1973-01-01             6.1777601             6.1777601
    ## 15: 1974-01-01 1974-01-01            11.0548048            11.0548048
    ## 16: 1975-01-01 1975-01-01             9.1431469             9.1431469
    ## 17: 1976-01-01 1976-01-01             5.7448126             5.7448126
    ## 18: 1977-01-01 1977-01-01             6.5016840             6.5016840
    ## 19: 1978-01-01 1978-01-01             7.6309638             7.6309638
    ## 20: 1979-01-01 1979-01-01            11.2544711            11.2544711
    ## 21: 1980-01-01 1980-01-01            13.5492020            13.5492020
    ## 22: 1981-01-01 1981-01-01            10.3347153            10.3347153
    ## 23: 1982-01-01 1982-01-01             6.1314270             6.1314270
    ## 24: 1983-01-01 1983-01-01             3.2124352             3.2124352
    ## 25: 1984-01-01 1984-01-01             4.3005355             4.3005355
    ## 26: 1985-01-01 1985-01-01             3.5456442             3.5456442
    ## 27: 1986-01-01 1986-01-01             1.8980477             1.8980477
    ## 28: 1987-01-01 1987-01-01             3.6645632             3.6645632
    ## 29: 1988-01-01 1988-01-01             4.0777411             4.0777411
    ## 30: 1989-01-01 1989-01-01             4.8270030             4.8270030
    ## 31: 1990-01-01 1990-01-01             5.3979564             5.3979564
    ## 32: 1991-01-01 1991-01-01             4.2349640             4.2349640
    ## 33: 1992-01-01 1992-01-01             3.0288197             3.0288197
    ## 34: 1993-01-01 1993-01-01             2.9516570             2.9516570
    ## 35: 1994-01-01 1994-01-01             2.6074416             2.6074416
    ## 36: 1995-01-01 1995-01-01             2.8054197             2.8054197
    ## 37: 1996-01-01 1996-01-01             2.9312042             2.9312042
    ## 38: 1997-01-01 1997-01-01             2.3376899             2.3376899
    ## 39: 1998-01-01 1998-01-01             1.5522791             1.5522791
    ## 40: 1999-01-01 1999-01-01             2.1880272             2.1880272
    ## 41: 2000-01-01 2000-01-01             3.3768573             3.3768573
    ## 42: 2001-01-01 2001-01-01             2.8261711             2.8261711
    ## 43: 2002-01-01 2002-01-01             1.5860316             1.5860316
    ## 44: 2003-01-01 2003-01-01             2.2700950             2.2700950
    ## 45: 2004-01-01 2004-01-01             2.6772367             2.6772367
    ## 46: 2005-01-01 2005-01-01             3.3927468             3.3927468
    ## 47: 2006-01-01 2006-01-01             3.2259441             3.2259441
    ## 48: 2007-01-01 2007-01-01             2.8526725             2.8526725
    ## 49: 2008-01-01 2008-01-01             3.8391003             3.8391003
    ## 50: 2009-01-01 2009-01-01            -0.3555463            -0.3555463
    ## 51: 2010-01-01 2010-01-01             1.6400434             1.6400434
    ## 52: 2011-01-01 2011-01-01             3.1568416             3.1568416
    ## 53: 2012-01-01 2012-01-01             2.0693373             2.0693373
    ## 54: 2013-01-01 2013-01-01             1.4648327             1.4648327
    ## 55: 2014-01-01 2014-01-01             1.6222230             1.6222230
    ## 56: 2015-01-01 2015-01-01             0.1186271             0.1186271
    ## 57: 2016-01-01 2016-01-01             1.2615832             1.2615832
    ## 58: 2017-01-01 2017-01-01             2.1301100             2.1301100
    ## 59: 2018-01-01 2018-01-01             2.4425833             2.4425833
    ## 60: 2019-01-01 2019-01-01             1.8122101             1.8122101
    ## 61: 2020-01-01 2020-01-01             1.2335844             1.2335844
    ##       date...1   date...3 inflation_percent...2 inflation_percent...4
